<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ハナハナ設定推測カウンター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .counter-btn {
            transition: all 0.1s ease-in-out;
        }
        .counter-btn:active {
            transform: scale(0.95);
        }
        .result-bar-inner {
            transition: width 0.3s ease-in-out;
        }
        .hibiscus-gradient {
            background-image: linear-gradient(to right, #f87171, #fb923c, #facc15);
        }
        .hibiscus-text {
            background: -webkit-linear-gradient(left, #ef4444, #f97316, #eab308);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

    <div class="max-w-2xl mx-auto text-center">
        <!-- ヘッダー -->
        <header class="mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold hibiscus-text">ハナハナ設定推測</h1>
            <p class="text-gray-400 mt-1">現行4機種対応</p>
        </header>

        <main class="space-y-6">
            <!-- 入力パネル -->
            <section class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                <!-- 機種選択 -->
                <div class="mb-6">
                    <label for="machine-select" class="block text-base font-semibold mb-2 text-gray-300">機種選択</label>
                    <select id="machine-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="star-hanahana">スターハナハナ</option>
                        <option value="dragon-hanahana">ドラゴンハナハナ～閃光～</option>
                        <option value="king-hanahana">キングハナハナ</option>
                        <option value="hanahana-houou">ハナハナホウオウ～天翔～</option>
                    </select>
                </div>

                <!-- 基本情報カウンター -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div>
                        <label for="games" class="block text-sm font-medium text-gray-400 mb-1">総G数</label>
                        <input type="number" id="games" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-center text-lg font-semibold" placeholder="0" inputmode="numeric">
                    </div>
                    <div>
                        <label for="big-count" class="block text-sm font-medium text-gray-400 mb-1">BIG</label>
                        <input type="number" id="big-count" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-center text-lg font-semibold" placeholder="0" inputmode="numeric">
                    </div>
                    <div>
                        <label for="reg-count" class="block text-sm font-medium text-gray-400 mb-1">REG</label>
                        <input type="number" id="reg-count" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-center text-lg font-semibold" placeholder="0" inputmode="numeric">
                    </div>
                </div>

                <!-- 詳細カウンター -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <!-- ベル -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">通常時ベル</label>
                        <div class="flex items-center gap-1">
                            <button onclick="updateCounter('bellCount', null, -1)" class="counter-btn bg-gray-600 w-10 h-10 rounded-lg text-2xl font-bold">-</button>
                            <input type="number" id="bellCount-input" class="w-full bg-gray-700 rounded-lg text-center h-10 text-lg font-semibold" value="0" inputmode="numeric">
                            <button onclick="updateCounter('bellCount', null, 1)" class="counter-btn bg-yellow-500 w-10 h-10 rounded-lg text-2xl font-bold">+</button>
                        </div>
                        <p id="bell-info" class="text-xs text-yellow-400 mt-1"></p>
                    </div>
                    <!-- BIG中スイカ -->
                     <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">BIG中スイカ</label>
                         <div class="flex items-center gap-1">
                            <button onclick="updateCounter('bigスイカCount', null, -1)" class="counter-btn bg-gray-600 w-10 h-10 rounded-lg text-2xl font-bold">-</button>
                            <input type="number" id="bigスイカCount-input" class="w-full bg-gray-700 rounded-lg text-center h-10 text-lg font-semibold" value="0" inputmode="numeric">
                            <button onclick="updateCounter('bigスイカCount', null, 1)" class="counter-btn bg-red-500 w-10 h-10 rounded-lg text-2xl font-bold">+</button>
                        </div>
                        <p id="bigスイカ-info" class="text-xs text-yellow-400 mt-1"></p>
                    </div>
                </div>

                <!-- 設定示唆演出 -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-300 border-b border-gray-600 pb-2">設定示唆演出</h3>
                    <!-- REG中サイドランプ -->
                    <div>
                         <label class="block text-sm font-medium text-gray-400 mb-2">REG中サイドランプ (スイカ揃い時)</label>
                         <div class="grid grid-cols-2 gap-4" id="reg-side-lamp-grid"></div>
                    </div>
                    <!-- ボーナス後ランプ -->
                     <div>
                        <label id="bonus-end-lamp-label" class="block text-sm font-medium text-gray-400 mb-2">ボーナス後ランプ</label>
                        <p id="end-lamp-info" class="text-xs text-yellow-400 -mt-1 mb-3"></p>
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm font-semibold mb-2">BIG後</p>
                                <div id="end-lamp-big-grid"></div>
                            </div>
                             <div>
                                <p class="text-sm font-semibold mb-2">REG後</p>
                                <div id="end-lamp-reg-grid"></div>
                            </div>
                        </div>
                     </div>
                </div>
            </section>

            <!-- 現在の確率表示 -->
            <section class="bg-gray-800 p-4 rounded-2xl shadow-lg">
                 <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div>
                        <p class="text-xs text-gray-400">BIG</p>
                        <p id="current-big-prob" class="text-lg font-semibold">1/---</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400">REG</p>
                        <p id="current-reg-prob" class="text-lg font-semibold">1/---</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400">合算</p>
                        <p id="current-total-prob" class="text-lg font-semibold">1/---</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400">ベル</p>
                        <p id="current-bell-prob" class="text-lg font-semibold">1/---</p>
                    </div>
                </div>
            </section>

            <!-- 結果表示パネル -->
            <section class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-200">設定推測結果</h2>
                <div class="space-y-2.5" id="result-bars"></div>
                <div id="確定-info-panel" class="mt-4 bg-gray-900 p-3 rounded-lg hidden">
                    <p class="text-base font-bold text-yellow-300">🎉 確定情報 🎉</p>
                    <p id="確定-info-text" class="mt-1 text-sm text-gray-300"></p>
                </div>
            </section>
        </main>
        
        <!-- リセットボタン -->
        <div class="mt-8">
            <button id="reset-btn" class="w-full bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold transition">全リセット</button>
        </div>
    </div>

    <script>
        // --- データ定義 ---
        const machineData = {
            'star-hanahana': { name: 'スターハナハナ', spec: [{ setting: 1, big: 1/270, reg: 1/387, total: 1/159 },{ setting: 2, big: 1/262, reg: 1/354, total: 1/150 },{ setting: 3, big: 1/252, reg: 1/322, total: 1/141 },{ setting: 4, big: 1/240, reg: 1/293, total: 1/132 },{ setting: 5, big: 1/229, reg: 1/267, total: 1/123 },{ setting: 6, big: 1/218, reg: 1/242, total: 1/114 },], bell: { 1: 1/7.5, 6: 1/7.2 }, bigスイカ: { 1: 1/42, 6: 1/34 }, regSideLamp: { blue: { odd: 1.2, even: 0.8 }, green: { odd: 1.2, even: 0.8 }, yellow: { odd: 0.8, even: 1.2 }, red: { odd: 0.8, even: 1.2 }, }, endLamp: { label: 'ボーナス後フェザーランプ', 確定: { rainbow: 6 }, weights: { blue: 1.1, yellow: 1.2, green: 1.3, red: 1.4, rainbow: 2.0 } } },
            'dragon-hanahana': { name: 'ドラゴンハナハナ～閃光～', spec: [{ setting: 1, big: 1/256, reg: 1/642, total: 1/183 },{ setting: 2, big: 1/246, reg: 1/585, total: 1/173 },{ setting: 3, big: 1/235, reg: 1/537, total: 1/163 },{ setting: 4, big: 1/224, reg: 1/489, total: 1/153 },{ setting: 5, big: 1/212, reg: 1/442, total: 1/143 },{ setting: 6, big: 1/199, reg: 1/399, total: 1/133 },], bell: { 1: 1/7.7, 6: 1/7.1 }, bigスイカ: { 1: 1/34, 6: 1/30 }, regSideLamp: { blue: [0, 0, 0, 0, 0, 0.555], yellow: [0.6, 0, 0, 0, 0, 0.222], green: [0, 0, 0, 0, 0, 0], red: [0.4, 0, 0, 0, 0, 0.222], }, endLamp: { label: 'ボーナス後フェザーランプ', 確定: { rainbow: 6 }, weights: { blue: 1.0, yellow: 1.1, green: 1.1, red: 1.2, rainbow: 2.0 } } },
            'king-hanahana': { name: 'キングハナハナ', spec: [{ setting: 1, big: 1/292, reg: 1/489, total: 1/183 },{ setting: 2, big: 1/280, reg: 1/452, total: 1/172 },{ setting: 3, big: 1/268, reg: 1/420, total: 1/163 },{ setting: 4, big: 1/257, reg: 1/390, total: 1/154 },{ setting: 5, big: 1/244, reg: 1/360, total: 1/145 },{ setting: 6, big: 1/232, reg: 1/332, total: 1/136 },], bell: { 1: 1/7.97, 6: 1/7.08 }, bigスイカ: { 1: 1/41.5, 6: 1/32.5 }, regSideLamp: { blue: { odd: 1.2, even: 0.8 }, green: { odd: 1.2, even: 0.8 }, yellow: { odd: 0.8, even: 1.2 }, red: { odd: 0.8, even: 1.2 }, }, endLamp: { label: 'REG後フェザーランプ', 確定: { blue: 2, yellow: 3, green: 4, red: 5, rainbow: 6 }, weights: null } },
            'hanahana-houou': { name: 'ハナハナホウオウ～天翔～', spec: [{ setting: 1, big: 1/297, reg: 1/496, total: 1/186 },{ setting: 2, big: 1/284, reg: 1/458, total: 1/175 },{ setting: 3, big: 1/273, reg: 1/425, total: 1/166 },{ setting: 4, big: 1/262, reg: 1/397, total: 1/157 },{ setting: 5, big: 1/249, reg: 1/366, total: 1/148 },{ setting: 6, big: 1/236, reg: 1/337, total: 1/139 },], bell: { 1: 1/8.2, 6: 1/7.4 }, bigスイカ: { 1: 1/48, 4: 1/24, 5: 1/16, 6: 1/12 }, regSideLamp: { blue: [0, 0, 0, 0, 0, 0], yellow: [0, 0, 0, 0, 0, 0], green: [0, 0, 0, 0, 0, 0.4], red: [0, 0, 0, 0, 0, 0.5], }, endLamp: { label: 'ボーナス後TOPパネル', 確定: { rainbow: 6 }, weights: { blue: 1.1, yellow: 1.2, green: 1.3, red: 1.4, rainbow: 2.0 } } }
        };

        // --- 状態管理 ---
        let allMachineStates = {};
        let state;
        const getInitialState = (machineId) => ({
            machine: machineId, games: 0, bigCount: 0, regCount: 0, bellCount: 0, bigスイカCount: 0,
            regSideLamp: { blue: 0, yellow: 0, green: 0, red: 0 },
            endLamp: {
                big: { blue: 0, yellow: 0, green: 0, red: 0, rainbow: 0 },
                reg: { blue: 0, yellow: 0, green: 0, red: 0, rainbow: 0 }
            }
        });

        // --- DOM要素 ---
        const machineSelect = document.getElementById('machine-select');
        const gamesInput = document.getElementById('games');
        const bigCountInput = document.getElementById('big-count');
        const regCountInput = document.getElementById('reg-count');
        const resultBarsContainer = document.getElementById('result-bars');
        const resetBtn = document.getElementById('reset-btn');

        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', () => {
            const initialMachine = 'star-hanahana';
            allMachineStates[initialMachine] = getInitialState(initialMachine);
            state = allMachineStates[initialMachine];
            
            buildIndicatorCounters();
            setupEventListeners();
            updateUIForMachine();
            renderResultBars();
            calculateAndDisplay();
        });
        
        // --- 設定示唆カウンターの動的生成 ---
        function buildIndicatorCounters() {
            const regSideLampGrid = document.getElementById('reg-side-lamp-grid');
            const endLampBigGrid = document.getElementById('end-lamp-big-grid');
            const endLampRegGrid = document.getElementById('end-lamp-reg-grid');
            
            const colors = {
                blue: { name: '青', bg: 'bg-blue-600', plus: 'bg-blue-500' },
                yellow: { name: '黄', bg: 'bg-yellow-500', plus: 'bg-yellow-400' },
                green: { name: '緑', bg: 'bg-green-600', plus: 'bg-green-500' },
                red: { name: '赤', bg: 'bg-red-600', plus: 'bg-red-500' },
                rainbow: { name: '虹', bg: 'hibiscus-gradient', plus: 'hibiscus-gradient' }
            };

            // REGサイドランプ
            Object.entries(colors).forEach(([key, val]) => {
                if (key === 'rainbow') return;
                const html = `
                    <div class="bg-gray-700 p-2 rounded-lg">
                        <div class="flex items-center justify-center gap-2 mb-2">
                            <span class="w-4 h-4 rounded-full ${val.bg}"></span>
                            <span class="font-semibold">${val.name}</span>
                        </div>
                        <div class="flex items-center gap-1 mx-2">
                            <button onclick="updateCounter('regSideLamp', '${key}', -1)" class="counter-btn bg-gray-600 w-8 h-8 rounded-md text-xl">-</button>
                            <input type="number" id="regSideLamp-${key}-input" class="w-full bg-gray-900 rounded text-center h-8 font-semibold" value="0" inputmode="numeric">
                            <button onclick="updateCounter('regSideLamp', '${key}', 1)" class="counter-btn ${val.plus} w-8 h-8 rounded-md text-xl">+</button>
                        </div>
                    </div>`;
                regSideLampGrid.innerHTML += html;
            });
            
            // ボーナス後ランプ
            ['big', 'reg'].forEach(type => {
                const container = type === 'big' ? endLampBigGrid : endLampRegGrid;
                const colorEntries = Object.entries(colors);
                const topRow = colorEntries.slice(0, 3);
                const bottomRow = colorEntries.slice(3);

                let topHtml = '<div class="grid grid-cols-3 gap-2">';
                topRow.forEach(([key, val]) => {
                    topHtml += createLampButtonHtml(type, key, val);
                });
                topHtml += '</div>';

                let bottomHtml = '<div class="flex justify-center gap-2 mt-2">';
                bottomRow.forEach(([key, val]) => {
                    bottomHtml += `<div class="w-[49%]">${createLampButtonHtml(type, key, val)}</div>`;
                });
                bottomHtml += '</div>';

                container.innerHTML = topHtml + bottomHtml;
            });
        }
        
        function createLampButtonHtml(type, key, val) {
            return `
                <div class="bg-gray-700 p-2 rounded-lg">
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <span class="w-4 h-4 rounded-full ${val.bg}"></span>
                        <span class="font-semibold">${val.name}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="updateCounter('endLamp', '${type}-${key}', -1)" class="counter-btn bg-gray-600 w-8 h-8 rounded-md text-xl">-</button>
                        <input type="number" id="endLamp-${type}-${key}-input" class="w-full bg-gray-900 rounded text-center h-8 font-semibold" value="0" inputmode="numeric">
                        <button onclick="updateCounter('endLamp', '${type}-${key}', 1)" class="counter-btn ${val.plus} w-8 h-8 rounded-md text-xl">+</button>
                    </div>
                </div>`;
        }


        // --- イベントリスナー ---
        function setupEventListeners() {
            machineSelect.addEventListener('change', (e) => {
                const newMachineId = e.target.value;
                if (!allMachineStates[newMachineId]) {
                    allMachineStates[newMachineId] = getInitialState(newMachineId);
                }
                state = allMachineStates[newMachineId];
                populateUIFromState();
                updateUIForMachine();
                calculateAndDisplay();
            });

            [gamesInput, bigCountInput, regCountInput].forEach(input => 
                input.addEventListener('input', () => {
                    updateStateFromInputs();
                    calculateAndDisplay();
                })
            );
            
            document.querySelectorAll('input[type=number]').forEach(input => {
                if (['games', 'big-count', 'reg-count'].includes(input.id)) return;
                input.addEventListener('input', (e) => {
                    const parts = e.target.id.split('-');
                    const category = parts[0];
                    const type = parts.length === 3 ? `${parts[1]}-${parts[2]}` : (parts.length === 2 ? null : parts[1]);
                    updateCounter(category, type, 0, parseInt(e.target.value) || 0);
                });
            });

            resetBtn.addEventListener('click', () => {
                if (confirm('すべての入力データをリセットしますか？')) {
                    const currentMachineId = state.machine;
                    allMachineStates = {};
                    allMachineStates[currentMachineId] = getInitialState(currentMachineId);
                    state = allMachineStates[currentMachineId];
                    populateUIFromState();
                    calculateAndDisplay();
                }
            });
        }
        
        function populateUIFromState() {
            gamesInput.value = state.games || '';
            bigCountInput.value = state.bigCount || '';
            regCountInput.value = state.regCount || '';
            document.getElementById('bellCount-input').value = state.bellCount;
            document.getElementById('bigスイカCount-input').value = state.bigスイカCount;
            
            Object.keys(state.regSideLamp).forEach(color => {
                document.getElementById(`regSideLamp-${color}-input`).value = state.regSideLamp[color];
            });
            ['big', 'reg'].forEach(type => {
                Object.keys(state.endLamp[type]).forEach(color => {
                    document.getElementById(`endLamp-${type}-${color}-input`).value = state.endLamp[type][color];
                });
            });
        }

        function updateUIForMachine() {
            const data = machineData[state.machine];
            document.getElementById('bell-info').textContent = data.name === 'スターハナハナ' ? `※推定値を基に計算` : `設定1: ${formatProb(data.bell[1])} ～ 6: ${formatProb(data.bell[6])}`;
            document.getElementById('bigスイカ-info').textContent = data.name === 'スターハナハナ' ? `※推定値を基に計算` : `高設定ほど優遇`;
            document.getElementById('bonus-end-lamp-label').textContent = data.endLamp.label;
            document.getElementById('end-lamp-info').textContent = data.endLamp.確定 ? '※REG後の色で設定が確定する場合があります' : '※高設定ほど白以外が選ばれやすい傾向';
        }
        
        function updateStateFromInputs() {
            state.games = parseInt(gamesInput.value) || 0;
            state.bigCount = parseInt(bigCountInput.value) || 0;
            state.regCount = parseInt(regCountInput.value) || 0;
        }

        function updateCounter(category, type, change, directValue = -1) {
            let targetState, inputElement;
            if (category === 'bellCount' || category === 'bigスイカCount') {
                state[category] = directValue !== -1 ? directValue : Math.max(0, state[category] + change);
                document.getElementById(`${category}-input`).value = state[category];
            } else {
                let mainKey, subKey;
                 if (category === 'regSideLamp') {
                    [mainKey, subKey] = [category, type];
                    targetState = state[mainKey];
                 } else { // endLamp
                    [mainKey, subKey] = [category, type.split('-')[0]];
                    const colorKey = type.split('-')[1];
                    targetState = state[mainKey][subKey];
                    subKey = colorKey;
                 }
                 targetState[subKey] = directValue !== -1 ? directValue : Math.max(0, targetState[subKey] + change);
                 inputElement = document.getElementById(`${category}-${type}-input`);
                 if (inputElement) inputElement.value = targetState[subKey];
            }
            calculateAndDisplay();
        }
        
        function calculateAndDisplay() {
            updateStateFromInputs();
            document.getElementById('current-big-prob').textContent = state.bigCount > 0 ? `1/${(state.games / state.bigCount).toFixed(1)}` : '1/---';
            document.getElementById('current-reg-prob').textContent = state.regCount > 0 ? `1/${(state.games / state.regCount).toFixed(1)}` : '1/---';
            const totalBonus = state.bigCount + state.regCount;
            document.getElementById('current-total-prob').textContent = totalBonus > 0 ? `1/${(state.games / totalBonus).toFixed(1)}` : '1/---';
            document.getElementById('current-bell-prob').textContent = state.bellCount > 0 ? `1/${(state.games / state.bellCount).toFixed(1)}` : '1/---';
            const results = calculateSettings();
            renderResultBars(results);
        }
        
        function calculateSettings() {
            const data = machineData[state.machine];
            let scores = [1, 1, 1, 1, 1, 1];

            let 確定Setting = 0;
            let 確定Color = '';
            const colorNames = {blue: '青', yellow: '黄', green: '緑', red: '赤', rainbow: '虹'};
            
            // 全機種共通のREG後虹は設定6確定
            if (state.endLamp.reg.rainbow > 0) {
                確定Setting = 6;
                確定Color = colorNames.rainbow;
            }
            // キングハナハナ固有のREG後ランプ確定パターン
            if (data.name === 'キングハナハナ') {
                for (const [color, setting] of Object.entries(data.endLamp.確定)) {
                    if (state.endLamp.reg[color] > 0 && setting > 確定Setting) {
                        確定Setting = setting;
                        確定Color = colorNames[color];
                    }
                }
            }
            
            const 確定Panel = document.getElementById('確定-info-panel');
            const 確定Text = document.getElementById('確定-info-text');
            if (確定Setting > 0) {
                scores.forEach((s, i) => {
                    if (i + 1 < 確定Setting) {
                        scores[i] = 0;
                    }
                });
                確定Panel.classList.remove('hidden');
                確定Text.textContent = `REG後${確定Color}ランプで設定${確定Setting}以上確定!`;
            } else {
                 確定Panel.classList.add('hidden');
            }

            if (state.games >= 100) {
                const currentBigProb = state.bigCount / state.games;
                const currentRegProb = state.regCount / state.games;
                data.spec.forEach((s, i) => {
                    if (scores[i] === 0) return;
                    const bigDiff = Math.abs(currentBigProb - s.big);
                    const regDiff = Math.abs(currentRegProb - s.reg);
                    const regWeight = state.machine === 'dragon-hanahana' ? 0.5 : 2.0;
                    const bigWeight = state.machine === 'dragon-hanahana' ? 3.0 : 1.0;
                    scores[i] *= (1 / (bigDiff * bigWeight + 0.0001)) * (1 / (regDiff * regWeight + 0.0001));
                });

                if (state.bellCount > 0) {
                    const currentBellProb = state.bellCount / state.games;
                    data.spec.forEach((s, i) => {
                        if (scores[i] === 0) return;
                        const bellProb = interpolate(data.bell, s.setting);
                        scores[i] *= (1 / (Math.abs(currentBellProb - bellProb) + 0.001));
                    });
                }
                if (state.bigスイカCount > 0 && state.bigCount > 0) {
                     const currentスイカProb = state.bigスイカCount / (state.bigCount * 24);
                     data.spec.forEach((s, i) => {
                        if (scores[i] === 0) return;
                        const スイカProb = interpolate(data.bigスイカ, s.setting);
                        scores[i] *= (1 / (Math.abs(currentスイカProb - スイカProb) + 0.001));
                     });
                }

                if (Object.values(state.regSideLamp).reduce((a, b) => a + b, 0) > 0) {
                    if (Array.isArray(data.regSideLamp.blue)) {
                        data.spec.forEach((s, i) => {
                             if (scores[i] === 0) return;
                             let lampScore = 1;
                             Object.keys(state.regSideLamp).forEach(color => {
                                 lampScore += state.regSideLamp[color] * (data.regSideLamp[color]?.[i] || 0);
                             });
                             scores[i] *= (lampScore > 0 ? lampScore : 0.1);
                        });
                    } else {
                        data.spec.forEach((s, i) => {
                            if (scores[i] === 0) return;
                            const isEven = (s.setting % 2 === 0);
                            const oddCount = state.regSideLamp.blue + state.regSideLamp.green;
                            const evenCount = state.regSideLamp.yellow + state.regSideLamp.red;
                            if (isEven) scores[i] *= Math.pow(1.2, evenCount) * Math.pow(0.8, oddCount);
                            else scores[i] *= Math.pow(1.2, oddCount) * Math.pow(0.8, evenCount);
                        });
                    }
                }
                
                if (data.endLamp.weights) {
                     ['big', 'reg'].forEach(type => {
                        Object.entries(state.endLamp[type]).forEach(([color, count]) => {
                            if (count > 0) {
                                const weight = data.endLamp.weights[color] || 1;
                                data.spec.forEach((s, i) => {
                                    if (scores[i] === 0) return;
                                    const settingWeight = 1 + (weight - 1) * (s.setting / 6);
                                    scores[i] *= Math.pow(settingWeight, count);
                                });
                            }
                        });
                     });
                }
            }

            const totalScore = scores.reduce((a, b) => a + b, 0);
            return totalScore > 0 ? scores.map(s => s / totalScore * 100) : [0,0,0,0,0,0];
        }

        function renderResultBars(results = []) {
            resultBarsContainer.innerHTML = '';
            const barColors = ['bg-blue-600', 'bg-cyan-600', 'bg-green-600', 'bg-yellow-500', 'bg-orange-500', 'bg-red-600'];
            for (let i = 0; i < 6; i++) {
                const percentage = results[i] || 0;
                resultBarsContainer.innerHTML += `
                    <div class="flex items-center">
                        <div class="w-8 text-center font-bold text-lg">${i + 1}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-7 overflow-hidden">
                            <div class="result-bar-inner ${barColors[i]} h-full flex items-center justify-end pr-2" style="width: ${percentage.toFixed(1)}%;">
                                <span class="font-semibold text-white text-shadow text-sm">${percentage.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>`;
            }
        }
        
        function formatProb(prob) { return `1/${(1/prob).toFixed(2)}`; }
        function interpolate(data, setting) {
            const known = Object.keys(data).map(Number).sort((a,b) => a-b);
            if (data[setting]) return data[setting];
            let lower = known.filter(s => s < setting).pop() || known[0];
            let upper = known.filter(s => s > setting).shift() || known[known.length - 1];
            if (lower === upper) return data[lower];
            return data[lower] + (data[upper] - data[lower]) * (setting - lower) / (upper - lower);
        }

    </script>
</body>
</html>
